# Obsidian Note Namer プラグイン仕様書

## 1. 概要

### 1.1 プラグイン名
**Note Namer** (仮称)

### 1.2 目的
Gemini APIを活用して、Obsidianノートのタイトル自動生成とタグ自動追加を行い、ノートの整理と検索性を向上させる。

### 1.3 ターゲットユーザー
- 大量のノートを管理するObsidianユーザー
- ノートの命名規則に悩むユーザー
- 効率的なタグ付けを行いたいユーザー

### 1.4 主要機能
1. ノート内容から適切なタイトルを自動生成
2. ノート内容から関連タグを自動生成・追加
3. Gemini APIによる高精度な日本語処理

---

## 2. 機能要件

### 2.1 タイトル自動生成機能

#### 2.1.1 概要
ノートの本文内容を解析し、検索性と再利用性の高い短い日本語タイトルを生成してファイル名をリネームする。

#### 2.1.2 入力
- アクティブなノートの本文テキスト（Frontmatter含む）

#### 2.1.3 出力
- 生成されたタイトルでファイル名をリネーム
- 成功/失敗の通知メッセージ

#### 2.1.4 タイトル生成ルール
- 最大40文字以内
- 内容の核となる名詞を含む
- 記号や絵文字を使用しない
- 汎用的な接頭辞（「メモ」「ノート」「日記」など）を付けない
- OS非互換文字（`/\:*?"<>|`）は自動的にスペースに置換
- 重複時は自動的に連番を付与（例: `タイトル - 2.md`）

#### 2.1.5 実行方法
- コマンドパレットから「Generate title with AI」を選択
- キーボードショートカット（設定可能）
- リボンアイコンをクリック（オプション）

#### 2.1.6 冪等性
- 現在のファイル名（拡張子除く）と生成されたタイトルが同じ場合、リネームを実行しない
- 「タイトルは既に最新です」というメッセージを表示

### 2.2 タグ自動生成・追加機能

#### 2.2.1 概要
ノートの本文内容からキーワードを抽出し、適切なタグをFrontmatterに自動追加する。

#### 2.2.2 入力
- アクティブなノートの本文テキスト（Frontmatter除く）

#### 2.2.3 出力
- Frontmatterの`tags`フィールドに生成されたタグを追加
- 成功/失敗の通知メッセージ

#### 2.2.4 タグ生成ルール
- カンマ区切りで複数タグを生成
- 複数単語はハイフン（`-`）で連結
- すべて小文字に正規化
- `#`記号は自動削除
- 重複タグは除去
- 既存タグは完全置き換え（追加ではない）

#### 2.2.5 実行方法
- コマンドパレットから「Generate tags with AI」を選択
- キーボードショートカット（設定可能）
- リボンアイコンをクリック（オプション）

#### 2.2.6 冪等性
- 既存のタグ配列と生成されたタグ配列が同じ場合、更新を実行しない
- 「タグは既に最新です」というメッセージを表示

---

## 3. 技術仕様

### 3.1 開発環境
- **言語**: TypeScript
- **フレームワーク**: Obsidian Plugin API
- **ビルドツール**: esbuild
- **パッケージマネージャー**: npm
- **最小対応Obsidianバージョン**: 0.15.0

### 3.2 外部API

#### 3.2.1 Gemini API
- **モデル**: `gemini-2.5-flash-lite`（デフォルト、設定で変更可能）
- **エンドポイント**: `https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent`
- **認証**: API Key方式

#### 3.2.2 API パラメータ

**タイトル生成:**
```json
{
  "temperature": 0.2,
  "topK": 1,
  "topP": 1,
  "maxOutputTokens": 64
}
```

**タグ生成:**
```json
{
  "temperature": 0.2,
  "topK": 1,
  "topP": 1,
  "maxOutputTokens": 128
}
```

### 3.3 プロンプトテンプレート

#### 3.3.1 タイトル生成プロンプト
```
あなたは編集者です。以下の本文から、検索性と再利用性の高い短い日本語タイトルを1つ作ってください。
要件:
- {maxTitleLength}文字以内
- 内容の核となる名詞を含める
- 記号や絵文字は禁止
- 「メモ/ノート/日記」などの汎用接頭辞は付けない
- 出力はタイトル文字列のみ

本文:
{content}
```

#### 3.3.2 タグ生成プロンプト
```
次のContentからキーワードを抽出しタグを日本語で生成してください。
追加のコメントなしで、カンマ区切りのリストとしてタグのみを返します。
複数の単語はハイフンで繋いでタグにしてください。

Content:
{content}
```

### 3.4 プラグイン構造

```
note-namer-obsidian/
├── src/
│   ├── main.ts                 # プラグインメインファイル
│   ├── settings.ts             # 設定管理
│   ├── services/
│   │   ├── gemini-client.ts    # Gemini API クライアント
│   │   ├── title-generator.ts  # タイトル生成ロジック
│   │   └── tag-generator.ts    # タグ生成ロジック
│   ├── utils/
│   │   ├── env-loader.ts       # 環境変数読み込み
│   │   ├── text-sanitizer.ts   # テキスト正規化
│   │   └── validator.ts        # バリデーション
│   └── ui/
│       └── setting-tab.ts      # 設定UI
├── manifest.json
├── package.json
├── tsconfig.json
└── esbuild.config.mjs
```

---

## 4. 設定項目

### 4.1 API設定
| 設定項目 | デフォルト値 | 説明 |
|---------|-------------|------|
| `apiKey` | （空文字列） | Gemini API キー |
| `model` | `gemini-2.5-flash-lite` | 使用するGeminiモデル |

### 4.2 タイトル生成設定
| 設定項目 | デフォルト値 | 説明 |
|---------|-------------|------|
| `maxTitleLength` | 40 | タイトルの最大文字数 |
| `temperature` | 0.2 | API temperature パラメータ |
| `maxOutputTokens` | 64 | 最大出力トークン数 |

### 4.3 タグ生成設定
| 設定項目 | デフォルト値 | 説明 |
|---------|-------------|------|
| `temperature` | 0.2 | API temperature パラメータ |
| `maxOutputTokens` | 128 | 最大出力トークン数 |
| `maxContentLength` | 100 | プロンプトに含める本文の最大文字数 |

### 4.4 UI設定
| 設定項目 | デフォルト値 | 説明 |
|---------|-------------|------|
| `showRibbonIcons` | false | リボンアイコンの表示/非表示 |
| `enableNotifications` | true | 通知メッセージの有効/無効 |

---

## 5. UI/UX仕様

### 5.1 コマンド

#### 5.1.1 タイトル生成コマンド
- **ID**: `note-namer-generate-title`
- **名称**: "Generate title with AI"
- **実行条件**: アクティブなMarkdownファイルが存在すること
- **フィードバック**:
  - 成功時: `タイトル更新: {旧ファイル名} → {新タイトル}`
  - すでに最新: `タイトルは既に最新です: {タイトル}`
  - エラー時: エラー内容を通知

#### 5.1.2 タグ生成コマンド
- **ID**: `note-namer-generate-tags`
- **名称**: "Generate tags with AI"
- **実行条件**: アクティブなMarkdownファイルが存在すること
- **フィードバック**:
  - 成功時: `タグを更新しました: {タグリスト}`
  - すでに最新: `タグは既に最新です: {タグリスト}`
  - エラー時: エラー内容を通知

### 5.2 リボンアイコン（オプション）
- タイトル生成用アイコン（設定で有効化可能）
- タグ生成用アイコン（設定で有効化可能）

### 5.3 設定画面

#### セクション構成
1. **API設定**
   - Gemini APIキー入力フィールド（password type）
   - APIキー取得リンク: https://aistudio.google.com/app/apikey
   - モデル選択ドロップダウン

2. **タイトル生成設定**
   - 最大文字数スライダー（10-100）
   - Temperature スライダー（0.0-1.0）

3. **タグ生成設定**
   - Temperature スライダー（0.0-1.0）
   - 最大コンテンツ長スライダー（50-500）

4. **表示設定**
   - リボンアイコン表示トグル
   - 通知表示トグル

---

## 6. エラーハンドリング

### 6.1 API関連エラー

| エラー種別 | 条件 | メッセージ |
|-----------|------|-----------|
| APIキー未設定 | APIキーが空または未設定 | `GEMINI_API_KEY が未設定です。設定画面でAPIキーを入力してください。` |
| APIキー不正 | キー形式が不正（長さ<20、`AI`で始まらない） | `Gemini APIキーの形式が不正です。正しいキーを設定してください。` |
| API呼び出し失敗 | HTTPステータス≠200 | `Gemini API エラー: {status} {response}` |
| レスポンス解析失敗 | 応答から結果を抽出できない | `タイトル/タグ生成に失敗しました。` |

### 6.2 ファイル操作エラー

| エラー種別 | 条件 | メッセージ |
|-----------|------|-----------|
| ファイル未選択 | アクティブファイルがない | `アクティブなファイルがありません。ノートを開いて実行してください。` |
| 空ファイル | 本文が空または空白のみ | `本文が空です。テキストを入力してから実行してください。` |
| リネーム失敗 | ファイルのリネームに失敗 | `ファイルのリネームに失敗しました: {error}` |

### 6.3 ネットワークエラー
- タイムアウト（30秒）
- 接続エラー
- メッセージ例: `ネットワークエラーが発生しました。接続を確認してください。`

---

## 7. セキュリティとプライバシー

### 7.1 APIキーの管理
- APIキーはObsidianのプラグインデータとして暗号化保存
- 設定画面ではパスワードフィールドとして表示
- ログやコンソール出力にAPIキーを含めない

### 7.2 データ送信
- ノート本文をGemini APIに送信（ユーザーの同意前提）
- 送信データは一時的な処理のみに使用（Googleの利用規約に従う）
- ローカルVault以外にデータを保存しない

### 7.3 プライバシー通知
初回起動時、または設定画面に以下の注意事項を表示：
```
このプラグインは、ノートの内容をGoogle Gemini APIに送信します。
機密情報を含むノートでの使用にはご注意ください。
```

---

## 8. パフォーマンス要件

### 8.1 応答時間
- タイトル生成: 通常2-5秒以内
- タグ生成: 通常2-5秒以内

### 8.2 リソース使用
- メモリ使用量: 最小限（設定データのみ保持）
- ネットワーク: API呼び出し時のみ通信

### 8.3 最適化
- API呼び出しのデバウンス（連続実行防止）
- タイムアウト設定（30秒）
- エラー時の適切なクリーンアップ

---

## 9. テスト要件

### 9.1 単体テスト
- テキストサニタイズ処理
- タグ正規化処理
- 環境変数読み込み
- バリデーション処理

### 9.2 統合テスト
- Gemini API連携
- ファイルリネーム処理
- Frontmatter更新処理

### 9.3 手動テスト項目
- [ ] 空ノートでの実行
- [ ] 日本語コンテンツでの実行
- [ ] 英語コンテンツでの実行
- [ ] 長文コンテンツでの実行
- [ ] 特殊文字を含むコンテンツでの実行
- [ ] APIキー未設定時の動作
- [ ] ネットワークエラー時の動作
- [ ] 同名ファイル存在時の動作
- [ ] すでに適切なタイトル/タグがある場合の動作

---

## 10. 今後の拡張可能性

### 10.1 短期的な拡張
- [ ] バッチ処理（複数ファイル一括処理）
- [ ] カスタムプロンプトテンプレート
- [ ] 他のLLMプロバイダ対応（OpenAI、Claude等）
- [ ] タグの追加モード（置き換えではなく追加）

### 10.2 中長期的な拡張
- [ ] 自動実行モード（ファイル保存時にトリガー）
- [ ] タイトル/タグの履歴管理とロールバック
- [ ] カスタムルールベースのフィルタリング
- [ ] フォルダ別の設定プロファイル
- [ ] 多言語対応（英語、中国語等）
- [ ] ローカルLLMモデル対応

### 10.3 コミュニティ要望
- ユーザーフィードバックに基づく機能追加
- プラグインAPIの公開（他プラグインとの連携）

---

## 11. リリース計画

### 11.1 v1.0.0（初回リリース）
- タイトル自動生成機能
- タグ自動生成機能
- 基本的な設定UI
- Gemini API連携

### 11.2 v1.1.0
- バグ修正
- パフォーマンス改善
- ユーザーフィードバック対応

### 11.3 v2.0.0
- バッチ処理機能
- カスタムプロンプト機能
- 他のLLMプロバイダ対応

---

## 12. 参考資料

### 12.1 関連ドキュメント
- [Obsidian Plugin Development Guide](./obsidian-plugin-development-guide.md)
- [Obsidian API Documentation](https://docs.obsidian.md/)
- [Gemini API Documentation](https://ai.google.dev/docs)

### 12.2 既存スクリプト
- [AutoTitleLLMGemini.js](./scripts/AutoTitleLLMGemini.js)
- [AutoTagLLMGemini.js](./scripts/AutoTagLLMGemini.js)

### 12.3 ライセンス
MIT License（予定）

---

**Document Version**: 1.0
**Last Updated**: 2025-11-10
**Author**: Development Team
